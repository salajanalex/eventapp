app.controller('show-a-table-list',function($scope,$state,$http,$rootScope,$stateParams,$timeout){
	$scope.omit=angular.isArray($stateParams.omit) ? $stateParams.omit : [$stateParams.omit]
	$scope.order=($stateParams.order && JSON.parse($stateParams.order)) || {}
	$scope.filter=($stateParams.filter && JSON.parse($stateParams.filter)) || []
	$scope.group=($stateParams.group && JSON.parse($stateParams.group)) || []
	$scope.refresh=function(){
		$timeout(function(){
			$http
				.get('../rows/'+ location.href.match(/\?.+/)[0])
				.then(function(ans){
					if(ans.data){
						$scope.rows=ans.data
					}
				})
				.catch(function(ans){
					console.log('catch',ans)
					alert(ans)
				})	
		},0)
	}
	$scope.refresh();
	$scope.downloadTable=function(){
		location.href='../rows/'+ location.href.match(/\?.+/)[0] + '&filename=moshe.csv&format=csv'
	}
	$scope.omitKey=function(key){
			var omit=$stateParams.omit || []
			if(!angular.isArray(omit)) omit=[omit]
			omit.push(key)
			$stateParams.omit=omit
			$state.go('show-a-table',$stateParams,{notify:false,reload:false})
			$scope.refresh();
	}
	$scope.removeOmitKey=function(key){
			delete $scope.omit[key]
			$stateParams.omit=$scope.omit
			$state.go('show-a-table',$stateParams,{notify:false,reload:false})
			$scope.refresh();
	}
	$scope.orderAsc=function(key){
			$scope.order[key]='asc'
			$stateParams.order=JSON.stringify($scope.order)
			$state.go('show-a-table',$stateParams,{notify:false,reload:false})
			$scope.refresh();
	}
	$scope.orderDesc=function(key){
			$scope.order[key]='desc'
			$stateParams.order=JSON.stringify($scope.order)
			$state.go('show-a-table',$stateParams,{notify:false,reload:false})
			$scope.refresh();
	}
	$scope.removeOrder=function(key){
			delete $scope.order[key]
			$stateParams.order=JSON.stringify($scope.order)
			$state.go('show-a-table',$stateParams,{notify:false,reload:false})
			$scope.refresh();
	}
	$scope.clickFilterOnField=function(key){
		bootbox.prompt('Enter query: ( you can start with > or < )',function(ans){
			// delete $scope.filter[key]
			// if(ans){
			// 	$scope.filter[key]=ans
			// }
			$scope.filter.push({field:key,value:ans})
			$stateParams.filter=JSON.stringify($scope.filter)
			$state.go('show-a-table',$stateParams,{notify:false,reload:false})
			$scope.refresh();
		})
	}
	$scope.removeFilterKey=function(index){
		$scope.filter.splice(index,1)
		$stateParams.filter=JSON.stringify($scope.filter)
		$state.go('show-a-table',$stateParams,{notify:false,reload:false})
		$scope.refresh();
	}
	$scope.groupKey=function(key){
		bootbox.prompt('Enter a function: sum, avg, count, min, max',function(ans){
				if(ans){
					$scope.group[key]=ans
				}
				$scope.group.push({field:key,value:ans})
				$stateParams.group=JSON.stringify($scope.group)
				$state.go('show-a-table',$stateParams,{notify:false,reload:false})
				$scope.refresh();
		})
	}
	$scope.removeGroupKey=function(index){
		$scope.group.splice(index,1)
		$stateParams.group=JSON.stringify($scope.group)
		$state.go('show-a-table',$stateParams,{notify:false,reload:false})
		$scope.refresh();
	}
})